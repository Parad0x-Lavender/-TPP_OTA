#!/bin/bash

if [ -z "$1" ] ; then
    echo "Usage: $0 <ota zip>"
    exit 1
fi

ROM="$1"

METADATA=$(unzip -p "$ROM" META-INF/com/android/metadata)
SDK_LEVEL=$(echo "$METADATA" | grep post-sdk-level | cut -f2 -d '=')
TIMESTAMP=$(echo "$METADATA" | grep post-timestamp | cut -f2 -d '=')

FILENAME=$(basename $ROM)
DEVICE=$(echo $FILENAME | cut -f1 -d '-' | cut -f2 -d '_')
ROMTYPE=$(echo $FILENAME | cut -f2 -d '-')
DATE=$(echo $FILENAME | cut -f5 -d '-')
ID=$(echo ${TIMESTAMP}${DEVICE}${SDK_LEVEL} | sha256sum | cut -f 1 -d ' ')
SIZE=$(du -b $ROM | cut -f1 -d '	')
TYPE=$(echo $FILENAME | cut -f2 -d '-')
VERSION=$(echo $FILENAME | cut -f3 -d '-')
RELASE_TAG=PixelProject_${DEVICE}-${ROMTYPE}-${VERSION}-${TIMESTAMP}

URL="https://github.com/Parad0x-Lavender/TPP_OTA/releases/download/${RELASE_TAG}/${FILENAME}"

response=$(jq -n --arg datetime $TIMESTAMP \
        --arg filename $FILENAME \
        --arg id $ID \
        --arg romtype $ROMTYPE \
        --arg size $SIZE \
        --arg url $URL \
        --arg version $VERSION \
        '$ARGS.named'
)
wrapped_response=$(jq -n --argjson response "[$response]" '$ARGS.named')

echo "$wrapped_response" > $DEVICE.json
git add $DEVICE.json changelog.txt
git commit -m "Update autogenerated json for TPP $DEVICE $VERSION ${DATE}"
git push

gh release create $RELASE_TAG $ROM --notes "Automated release for TPP $DEVICE $VERSION ${DATE}"